# Task Summary: Fix Replicate Integration and Related Issues

**Date:** 2025-06-10

## 1. Initial Task Definition

The user reported that the Replicate integration was not being triggered.
**User Input for Replicate:**
```json
{
  "prompt": "black forest gateau cake spelling out the words \"FLUX SCHNELL\", tasty, food photography, dynamic shot",
  "go_fast": true,
  "megapixels": "1",
  "num_outputs": 1,
  "aspect_ratio": "1:1",
  "output_format": "webp",
  "output_quality": 80,
  "num_inference_steps": 4
}
```
**Model for Replicate:** `black-forest-labs/flux-schnell`

**Initial Console Output:**
```
Retrieved 2 messages for session 68475269ac243dea71e709d3
Found 0 system messages: []
Clear Session: Ending existing active session 68475269ac243dea71e709d3
Session ended locally, sessionId: 68475269ac243dea71e709d3, userId: 66d4cc3284612233413beb77, channel: web
No existing session found. Attempting to create a new one.
New session created: 684754d8ac243dea71e70b38 with assistant 68371718ea9cfca965c63730
SSE connection closed by client
```
The user noted that other integrations were working.

## 2. Investigation and Issues Found

The investigation involved adding extensive logging to several key files to trace the execution flow:
- `src/integrations/actions/executors.ts`
- `src/services/integration.service.ts`
- `src/services/assistant/message-handling.service.ts`

**Key Issues Identified:**

*   **Issue 1: SSE Connection Closing Prematurely:**
    *   **Symptom:** Console logs consistently showed "SSE connection closed by client" immediately after session creation or very early in the `handleSessionMessage` function, before any tool execution logs appeared.
    *   **Root Cause Diagnosis:** This pointed to a problem either in the client-side SSE handling, an early error in the backend request lifecycle, or a hang during the initial setup for the LLM call.

*   **Issue 2: Google Gemini API Error with Tool Schemas:**
    *   **Symptom:** Once logging was added deep enough into `handleSessionMessage` and streaming was temporarily disabled for diagnosis, a Google API error emerged:
        `APICallError [AI_APICallError]: * GenerateContentRequest.tools[0].function_declarations[2].parameters.required[1]: property is not defined * GenerateContentRequest.tools[0].function_declarations[3].parameters.required[1]: property is not defined`
    *   **Root Cause:** This error indicated that Google's API was rejecting the tool definitions for `replicate_runReplicateModel` and `replicate_runReplicateImageModel`. Specifically, it had issues with parameters of `type: 'object'` that were marked as `required` and had an open-ended schema (e.g., `additionalProperties: true`, translating to `z.record(z.string(), z.any())` in Zod). Google's API likely expected a more defined structure for such required object parameters.

*   **Issue 3: Incorrect LLM Model Identifier (Minor/Side-track):**
    *   **Symptom:** At one point, the assistant was configured with `gpt-4.1-mini`.
    *   **Resolution:** This was temporarily overridden to `gpt-4o-mini` during debugging, though the primary issue was with the Google Gemini provider by the time the core error was found.

*   **Issue 4: Duplicate User Messages in LLM Prompt (Minor):**
    *   **Symptom:** Logs showed the `messages` array in `streamCallOptions` sometimes contained a duplicate of the user's message (one as a string, one as a content part array).
    *   **Resolution:** Logic was added to `handleSessionMessage` to prevent this specific duplication if the last history message was identical to the current input.

*   **Issue 5: Replicate Image Links Forcing Download:**
    *   **Symptom:** User reported that the GCS URL for images generated by Replicate was forcing a download instead of displaying inline in the browser.
    *   **Root Cause:**
        1.  The `Content-Type` determined in `replicate.service.ts` might default to `application/octet-stream` if Replicate's response headers were missing or generic.
        2.  The `uploadFile` function in `google.storage.service.ts` was not setting `Content-Disposition: inline` for viewable types.

## 3. Resolutions Applied

*   **Resolution for Issue 1 & 2 (Primary Fix for Replicate Triggering):**
    *   **File:** `src/integrations/replicate/replicate.actions.ts`
    *   **Change:** Modified the `input` parameter for `runReplicateModel` and `runReplicateImageModel`. Instead of `type: 'object'`, it was changed to `type: 'string'`, and renamed to `inputJsonString`. The action functions were updated to `JSON.parse(args.inputJsonString)` to get the input object.
    *   **Reason:** This simplifies the schema sent to the Google Gemini API, avoiding the "property is not defined" error for required complex objects. The LLM now needs to provide the input as a stringified JSON.

*   **Resolution for Issue 4 (Duplicate Messages):**
    *   **File:** `src/services/assistant/message-handling.service.ts`
    *   **Change:** Added logic before constructing `messagesForLlm` to check if the last message in `history` is identical to the current `userInput` (when it's a simple text message). If so, it replaces the last history entry with the current `userMessageForLlm` (which has the proper `contentParts` structure) instead of appending, thus avoiding direct back-to-back duplication of simple text inputs.

*   **Resolution for Issue 5 (Image Link Download):**
    *   **File 1:** `src/services/google.storage.service.ts`
        *   **Change:** Modified `uploadFile` and `uploadBuffer` functions to conditionally set `metadata.contentDisposition = 'inline'` for common image MIME types (e.g., `image/*`) and `application/pdf`.
        *   **Reason:** This instructs browsers to attempt to display these file types directly.
    *   **File 2:** `src/integrations/replicate/replicate.service.ts`
        *   **Change:** Refined the `downloadAndUploadImage` function to more accurately determine `contentType` and `finalFileName`. It now prioritizes extensions in provided filenames and uses a safer default (`image/png`) if the Replicate `Content-Type` header is missing or generic, preventing `application/octet-stream` from being used for known image types.
        *   **Reason:** Ensures files are uploaded to GCS with the correct MIME type and a clean filename, allowing the `Content-Disposition` logic to work effectively.

*   **Diagnostic Steps (Logging - to be reverted if desired):**
    *   Extensive `console.log` statements were added to:
        *   `src/integrations/actions/executors.ts`
        *   `src/services/integration.service.ts`
        *   `src/services/assistant/message-handling.service.ts`
    *   These logs were crucial for tracing the execution flow and pinpointing where the process was failing or hanging.
    *   A temporary override for `modelIdentifier` was added and then removed.
    *   A temporary disabling of streaming (`shouldStream = false;`) was used for diagnosis and then reverted.
    *   A temporary modification to pass `tools: {}` to `streamText` was used and then reverted.

## 4. Final Outcome

The Replicate integration is now reported by the user to be working correctly. Images generated via Replicate and stored in GCS are viewable directly in the browser. The core issue was related to the schema of tool parameters being sent to the Google Gemini API, which was resolved by changing the Replicate tool's `input` parameter to expect a JSON string.
